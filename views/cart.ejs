<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Cart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
  <div class="max-w-5xl mx-auto p-4">

    <h1 class="text-2xl font-bold mb-4">üõí Your Cart</h1>

    <% if (items.length===0) { %>
      <div class="bg-white p-6 rounded shadow text-center">
        <p>Your cart is empty.</p>
        <a href="/products" class="text-blue-600 font-semibold underline">Shop Now</a>
      </div>
      <% } else { %>

        <!-- CART ITEMS -->
        <div class="space-y-4">
          <% items.forEach(it=> { %>
            <div class="bg-white p-5 rounded-xl shadow flex flex-col md:flex-row gap-4" data-key="<%= it.key %>">

              <!-- IMAGE -->
              <img id="img-<%= it.key %>" src="<%= it.image %>"
                class="w-full md:w-32 h-32 object-contain border rounded-lg" />

              <!-- DETAILS -->
              <div class="flex-1 space-y-1">
                <h3 class="text-xl font-bold">
                  <%= it.name %>
                </h3>

                <p>üì¶ Carton Size: <span class="font-semibold">
                    <%= it.cartonSize %>
                  </span></p>
                <p>üßÆ Qty: <span class="font-semibold" id="qty-<%= it.key %>">
                    <%= it.qty %>
                  </span></p>
                <p>üî¢ Pieces: <span class="font-semibold text-purple-700" id="pieces-<%= it.key %>">
                    <%= it.totalPieces %>
                  </span></p>
                <p>üí∞ Price: ‚Çπ <%= it.price %> / piece</p>

                <!-- QTY CONTROLS -->
                <div class="flex items-center gap-3 mt-2">
                  <button onclick="updateQty('<%= it.key %>', 'dec')"
                    class="px-3 py-1 bg-gray-200 rounded text-lg font-bold">‚àí</button>

                  <span class="font-bold text-lg" id="qty-<%= it.key %>">
                    <%= it.qty %>
                  </span>

                  <button onclick="updateQty('<%= it.key %>', 'inc')"
                    class="px-3 py-1 bg-green-600 text-white rounded text-lg font-bold">+</button>
                </div>

              </div>

              <!-- TOTAL -->
              <div class="flex flex-col justify-between items-end">
                <p class="text-xl font-bold text-green-700" id="lineTotal-<%= it.key %>">
                  ‚Çπ <%= it.lineTotal %>
                </p>

                <form method="post" action="/cart/remove/<%= it.key %>">
                  <button class="bg-red-500 text-white px-4 py-1 rounded">
                    Remove
                  </button>
                </form>
              </div>
            </div>
            <% }) %>


        </div>



        <!-- CART TOTAL -->
        <div class="bg-white p-4 rounded-xl shadow mt-4 text-right">
          <p class="text-lg" id="subtotal">Subtotal: ‚Çπ <%= subtotal %>
          </p>
          <p class="text-2xl font-bold" id="total">Payable: ‚Çπ <%= total %>
          </p>

        </div>




        <!-- CUSTOMER DETAILS -->
        <div class="bg-white p-6 rounded-xl shadow mt-6">
          <h2 class="text-lg font-bold mb-4 text-gray-800">üë§ Customer Details</h2>

          <form method="post" action="/place-order" onsubmit="return validateForm()" class="space-y-4">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- NAME -->
              <div>
                <label class="text-sm font-semibold">Name</label>
                <input id="name" name="name" class="border p-2 w-full rounded-lg" placeholder="Enter name">
                <p id="nameErr" class="text-red-600 text-xs mt-1 hidden"></p>
              </div>

              <!-- PHONE -->
              <div>
                <label class="text-sm font-semibold">Phone</label>
                <input id="phone" name="phone" class="border p-2 w-full rounded-lg"
                  placeholder="10 digit mobile number">
                <p id="phoneErr" class="text-red-600 text-xs mt-1 hidden"></p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- PIN CODE -->
              <div>
                <label class="text-sm font-semibold">PIN Code</label>
                <input id="pincode" name="pincode" class="border p-2 w-full rounded-lg transition"
                  placeholder="Enter 6-digit PIN code">
                <p id="pinErr" class="text-red-600 text-xs mt-1 hidden"></p>
              </div>

              <!-- CITY -->
              <div>
                <label class="text-sm font-semibold">City</label>
                <input id="city" name="city" class="border p-2 w-full rounded-lg bg-gray-100" readonly>
              </div>

              <!-- STATE -->
              <div>
                <label class="text-sm font-semibold">State</label>
                <input id="state" name="state" class="border p-2 w-full rounded-lg bg-gray-100" readonly>
              </div>
            </div>

            <button class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold">
              üßæ Place Order
            </button>
          </form>
        </div>

        <!-- ACTIONS -->
        <div class="flex flex-col md:flex-row justify-between gap-2 mt-4">
          <a href="/products" class="px-4 py-2 bg-gray-300 rounded text-center">‚Üê Continue Shopping</a>

          <form method="post" action="/cart/clear">
            <button class="px-4 py-2 bg-red-600 text-white rounded w-full md:w-auto">Clear Cart</button>
          </form>
        </div>

        <% } %>
  </div>

  <!-- VALIDATION SCRIPT (UNCHANGED) -->
  <script>
    function validateForm() {
      console.log("VALIDATE CALLED");
      let ok = true;

      const name = document.getElementById("name");
      const phone = document.getElementById("phone");
      const pin = document.getElementById("pincode");
      const city = document.getElementById("city");
      const state = document.getElementById("state");

      document.querySelectorAll("p[id$='Err']").forEach(e => e.classList.add("hidden"));
      document.querySelectorAll("input").forEach(i =>
        i.classList.remove("border-red-500", "border-green-500")
      );

      if (!/^[A-Za-z ]{3,}$/.test(name.value.trim())) { showError(name, "nameErr", "Name must be at least 3 letters"); ok = false; } else markValid(name);
      if (!/^[0-9]{10}$/.test(phone.value.trim())) { showError(phone, "phoneErr", "Phone must be 10 digits"); ok = false; } else markValid(phone);
      if (!/^[0-9]{6}$/.test(pin.value.trim())) { showError(pin, "pinErr", "Enter valid 6-digit PIN"); ok = false; } else markValid(pin);
      if (city.value.trim() === "") { showError(city, "cityErr", "City not detected from PIN"); ok = false; } else markValid(city);
      if (state.value.trim() === "") { showError(state, "pinErr", "State not detected"); ok = false; } else markValid(state);

      return ok;
    }

    function showError(input, errId, msg) {
      input.classList.add("border-red-500");
      const err = document.getElementById(errId);
      err.innerText = msg;
      err.classList.remove("hidden");
    }

    function markValid(input) {
      input.classList.add("border-green-500");
    }
  </script>

  <script>
    const pinInput = document.getElementById("pincode");
    const cityInput = document.getElementById("city");
    const stateInput = document.getElementById("state");

    pinInput.addEventListener("input", () => {
      const pin = pinInput.value.trim();
      cityInput.value = "";
      stateInput.value = "";
      if (!/^[0-9]{6}$/.test(pin)) return;

      fetch(`https://api.postalpincode.in/pincode/${pin}`)
        .then(res => res.json())
        .then(data => {
          if (data[0].Status === "Success") {
            const postOffice = data[0].PostOffice[0];
            cityInput.value = postOffice.District;
            stateInput.value = postOffice.State;
            markValid(pinInput);
            markValid(cityInput);
            markValid(stateInput);
          } else { showError(pinInput, "pinErr", "Invalid PIN code"); }
        })
        .catch(() => { showError(pinInput, "pinErr", "PIN lookup failed"); });
    });
  </script>



  <!-- ‚úÖ UPDATE QTY WITHOUT PAGE SCROLL -->
  <script>
    async function updateQty(key, action) {
      try {
        const res = await fetch(`/cart/${action}/${key}`, { method: "POST" });
        const data = await res.json();

        if (data.qty === 0) {
          // remove item from DOM if qty is 0
          const itemDiv = document.querySelector(`div[data-key='${key}']`);
          if (itemDiv) itemDiv.remove();
        } else {
          // Update quantity
          const qtySpan = document.querySelector(`#qty-${key}`);
          if (qtySpan) qtySpan.innerText = data.qty;

          // Update total pieces
          const piecesSpan = document.querySelector(`#pieces-${key}`);
          if (piecesSpan) piecesSpan.innerText = data.totalPieces;

          // Update line total
          const lineTotal = document.querySelector(`#lineTotal-${key}`);
          if (lineTotal) lineTotal.innerText = "‚Çπ " + data.lineTotal;

          // Update image
          const img = document.querySelector(`#img-${key}`);
          if (img) img.src = data.image;
        }

        // Update subtotal and total
        const subtotalEl = document.querySelector("#subtotal");
        const totalEl = document.querySelector("#total");
        if (subtotalEl) subtotalEl.innerText = "‚Çπ " + data.subtotal;
        if (totalEl) totalEl.innerText = "‚Çπ " + data.total;

      } catch (err) {
        console.error("Failed to update cart:", err);
      }
    }
  </script>




</body>

</html>